"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6534],{26534:function(e,t,s){s.d(t,{Z:function(){return eC}});var n=s(11527),i=s(17438),a=s.n(i),l=s(50959),r=s(50694),c=s(95804),o=s(37708),d=s(80850),m=s(5907),u=s(33202),p=s(33886),x=s.n(p),h=s(82691),f=s.n(h),v=s(99613),j=s.n(v),g=s(2600),b=s.n(g),y=s(46283),N=s(23878),w=s(90484),D=s(61015),k=s(3131);let _=e=>{var t,s;let{sessionUser:i,item:a,onEditComment:r,onEdit:c,onRemove:o,onReport:m}=e,[u,p]=(0,l.useState)(a.is_liked),[x,h]=(0,l.useState)(a.votes),f=(e,t)=>{t.preventDefault(),(0,k.bg)()&&(0,w.arA)({id:e.id,is_like:e.is_liked?0:1}).then(()=>{h(u?x-1:x+1),p(!u)})},v=(null===(t=a.member_actions)||void 0===t?void 0:t.filter(e=>"edit"===e.action).length)>0,j=(null===(s=a.member_actions)||void 0===s?void 0:s.filter(e=>"delete"===e.action).length)>0;return(0,n.jsxs)("div",{className:"handle-bar font-size-14 d-flex justify-content-between",children:[(0,n.jsxs)("div",{className:"d-flex align-items-center",children:[(0,n.jsxs)(d.Z,{variant:"link",className:"text-secondary btn-reset",onClick:e=>f(a,e),"aria-label":"点赞",children:[(0,n.jsx)("span",{className:"mainLike-comment ".concat(u?"text-primary":""),children:(0,n.jsx)("i",{className:"fa-w-16 ".concat(u?"fas fa-thumbs-up":"far fa-thumbs-up"),style:{width:"1em"}})}),x>0&&(0,n.jsx)("span",{className:"mainLike-commentNum ms-1",children:x})]}),(0,n.jsx)("span",{className:"split-dot"}),(0,n.jsx)(d.Z,{variant:"link",className:"text-secondary btn-comment btn-reset",onClick:e=>{(0,k.bg)()&&r(a,"",e)},children:"回复"}),(0,n.jsx)("span",{className:"split-dot"}),(0,n.jsx)("span",{className:"text-secondary",children:(0,D.dq)(a.created)}),(null==a?void 0:a.ip_address)&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("span",{className:"split-dot"}),(0,n.jsxs)("span",{className:"text-secondary",children:["来自",a.ip_address]})]})]}),(0,n.jsxs)("div",{className:"control-area d-none align-items-center",children:[i&&v&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(d.Z,{variant:"link",className:"text-secondary edit btn-reset",onClick:e=>{e.preventDefault(),c(a)},children:"编辑"}),(0,n.jsx)("span",{className:"split-dot"})]}),i&&j&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(d.Z,{variant:"link",className:"text-secondary delete btn-reset",onClick:e=>o(a.id,e),children:"删除"}),(0,n.jsx)("span",{className:"split-dot"})]}),i&&(0,n.jsx)(d.Z,{variant:"link",className:"text-secondary comment-report btn-reset",onClick:e=>m(a,e),children:"举报"})]})]})};var C=(0,m.$j)(e=>{let{global:t}=e;return{sessionUser:t.sessionUser}})(l.memo(_)),Z=s(9718),E=s(54599),S=s(59089),I=s(5816),R=s(70678),F=s(42368),z=s(842);let U=["\uD83D\uDE00","\uD83D\uDE01","\uD83E\uDD23","\uD83D\uDE02","\uD83D\uDE04","\uD83D\uDE05","\uD83D\uDE06","\uD83D\uDE11","\uD83D\uDE12","\uD83D\uDE44","\uD83E\uDD14","\uD83D\uDE33","\uD83D\uDE1E","\uD83D\uDE21","\uD83D\uDE31","\uD83D\uDE37","\uD83D\uDC4D","\uD83D\uDC4E","\uD83D\uDC4A","\uD83D\uDC4C","\uD83E\uDD1D","\uD83D\uDE35","\uD83E\uDD19","\uD83E\uDD2B","\uD83D\uDE48","\uD83D\uDE49","\uD83D\uDE4A"],q=e=>{let{onSelected:t}=e,s=(0,D.Fe)();return"sf_app"===s?null:(0,n.jsx)(I.Z,{trigger:"click",placement:"bottom",rootClose:!0,overlay:(0,n.jsx)(R.Z,{className:"p-3",children:(0,n.jsx)(F.Z,{children:U.map((e,s)=>(0,n.jsx)(z.Z,{xs:2,children:(0,n.jsx)(d.Z,{variant:"link",className:"m-0 p-0 font-size-24 btn-no-border",onClick:()=>t(e),children:e})},s))})}),children:(0,n.jsx)(d.Z,{variant:"link",className:"me-3 btn-reset",onClick:e=>{e.preventDefault()},"aria-label":"提示",children:(0,n.jsx)("i",{className:"far fa-face-laugh text-secondary"})})},"bottom")},O=(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(a(),{id:"b3e1b6a7c9b96113",children:""})}),T=e=>(0,n.jsxs)(n.Fragment,{children:[O,(0,n.jsx)(q,{...e})]});var M=s(45767),V=s(79253),K=s(46543);let L=e=>{let{element:t,children:s,pageUsers:i}=e,[a,r]=(0,l.useState)([]),c=(0,l.useRef)(null),[o,d]=(0,l.useState)(""),[m,u]=(0,l.useState)([]),[p,x]=(0,l.useState)(0),[h,f]=(0,l.useState)(!1);(0,l.useEffect)(()=>{if(t)return t.addEventListener("input",v),()=>{t.removeEventListener("input",v)}},[t]),(0,l.useEffect)(()=>{let e=i[window.location.pathname];u(b()(e?[...e,...a]:[...a],"id"))},[i,a,o]);let v=()=>{let{value:e,selectionStart:s=0}=t;if(0>e.indexOf("@")&&d(""),!s)return;let n=e.substring(e.substring(0,s).lastIndexOf("@"),s);!(0>n.substring(n.lastIndexOf(" "),s).indexOf("@"))&&(d(n.substring(1)),n.substring(1)&&!h&&(f(!0),(0,w.LIC)().then(e=>{r(e)})))},j=e=>{let{value:s,selectionStart:n=0}=t;if(!n)return;let i=s.substring(s.substring(0,n).lastIndexOf("@"),n),a="@".concat(null==e?void 0:e.name,"[").concat(null==e?void 0:e.slug,"] ");t.value="".concat(s.substring(0,s.substring(0,n).lastIndexOf("@"))).concat(a).concat(s.substring(n)),u([]),d("");let l=n+a.length-i.length;t.setSelectionRange(l,l),t.focus()},g=o?m.filter(e=>0===e.name.indexOf(o)||0===e.slug.indexOf(o)):[],N=e=>{let t=e.keyCode;if(38===t&&p>0&&(e.preventDefault(),x(p-1)),40===t&&p<g.length-1&&(e.preventDefault(),x(p+1)),13===t&&p>-1&&p<=g.length-1){e.preventDefault();let t=g[p];j(t),x(0)}};return(0,n.jsxs)(V.Z,{className:"mentions-wrap",show:g.length>0,onKeyDown:N,children:[s,(0,n.jsx)(V.Z.Toggle,{as:K.Z,domType:"div",id:"mentions-toggle"}),(0,n.jsx)(V.Z.Menu,{className:g.length>0?"visabled":"hidden",ref:c,children:g.filter((e,t)=>t<5).map((e,t)=>(0,n.jsxs)(V.Z.Item,{className:"d-flex align-items-center ".concat(p===t?"bg-gray-200":""),onClick:()=>j(e),children:[(0,n.jsx)(y.Z,{className:"me-2",src:e.avatar_url,width:24,height:24,headdress:null==e?void 0:e.headdress_worn}),(0,n.jsx)("span",{className:"text-body me-1",children:e.name}),(0,n.jsxs)("small",{className:"text-secondary",children:["@",e.slug]})]},t))})]})},P=(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(a(),{id:"d6a7c16d4796689",children:".mentions-wrap .dropdown-toggle::after{display:none}"})}),A=e=>(0,n.jsxs)(n.Fragment,{children:[P,(0,n.jsx)(L,{...e})]});var B=(0,m.$j)(e=>{let{global:t}=e;return{pageUsers:t.pageUsers}})(l.memo(A)),$=s(87816);let H=!0,Q=e=>{var t,s;let{commentContent:i,inputRef:a,setCommentContent:r,onComment:c,sessionUser:o,defaultVisibleTip:m=!1}=e,[u,p]=(0,l.useState)(m),[x,h]=(0,l.useState)({isInvalid:!1,msg:""}),f=e=>{h(e)},v=e=>{let t=e.keyCode;13===t&&(e.ctrlKey||e.metaKey)&&H&&i&&(H=!1,setTimeout(()=>{H=!0},700),c({item:"comment",callback:f}))};(0,l.useEffect)(()=>{m!==u&&p(m)},[m]);let j=e=>{let t=a.current,{value:s,selectionStart:n=0}=t,i=s.slice(0,n)+e+s.slice(n);r(i);let l=n+e.length;t.setSelectionRange(l,l),t.focus()},g=()=>(new $.Z("aa_detailsPage_comment").clickEvent(),c({item:"comment",callback:f}));return(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)("div",{className:"mb-4 media",onKeyDown:v,children:[(0,n.jsx)(y.Z,{src:null==o?void 0:null===(t=o.user)||void 0===t?void 0:t.avatar_url,className:"me-3",width:38,height:38,"aria-hidden":"true",headdress:null==o?void 0:null===(s=o.user)||void 0===s?void 0:s.headdress_worn}),(0,n.jsxs)("div",{className:"media-body",children:[(0,n.jsx)(Z.Z,{className:"mb-3",children:(0,n.jsxs)(B,{element:a.current,children:[(0,n.jsx)(E.Z.Control,{as:"textarea",rows:3,ref:a,value:i,onChange:e=>{r(e.target.value)},className:"comment-text",placeholder:"撰写评论 …",onFocus:e=>{(0,k.bg)()||(e.preventDefault(),a.current.blur())},"aria-label":"评论",isInvalid:x.isInvalid}),(0,n.jsx)(E.Z.Control.Feedback,{type:"invalid",children:x.msg})]})}),(0,n.jsxs)("div",{className:"d-flex justify-content-end align-items-center",children:[(0,n.jsx)(d.Z,{variant:"link",className:"me-3 btn-reset",onClick:e=>{e.preventDefault(),p(!u)},"aria-label":"提示",children:(0,n.jsx)("i",{className:"far fa-circle-info text-secondary"})}),(0,n.jsx)(T,{onSelected:j}),(0,n.jsx)(M.Z,{className:"float-end",onClick:g,disabled:!i,children:"提交评论"})]}),(0,n.jsxs)(S.Z,{show:u,variant:"info",className:"mt-3 my-0 font-size-14",children:["评论支持部分 Markdown 语法：",(0,n.jsx)("code",{children:"**粗体** _斜体_ [链接](http://example.com) `代码` - 列表 > 引用"}),"。你还可以使用 ",(0,n.jsx)("code",{children:"@ "}),"来通知其他用户。"]})]})]})})};var Y=(0,m.$j)(e=>{let{global:t}=e;return{sessionUser:t.sessionUser}})(l.memo(Q));let G=e=>{let{isChild:t=!1,item:s,parentItem:i,onChangeOfComment:a,onComment:r}=e,c=(0,l.useRef)(null);(0,l.useEffect)(()=>{if(c.current&&((0,u.Z)(c.current),s.original_text)){let e=s.original_text.length;c.current.setSelectionRange(e,e)}},[c]);let o=e=>{i?a({...s,original_text:e},i):a({...s,original_text:e})},m=e=>{let t=c.current;if(!t)return;let{value:s,selectionStart:n=0}=t,i=s.slice(0,n)+e+s.slice(n);o(i);let a=n+e.length;t.setSelectionRange(a,a),t.focus()};return(0,n.jsxs)(E.Z,{className:"edit-form ".concat(t?"edit-reply-form":""),children:[(0,n.jsxs)(Z.Z,{className:"mb-3",children:[(0,n.jsx)(E.Z.Control,{as:"textarea",className:"comment-text",rows:1,ref:c,autoFocus:!0,value:s.original_text,size:"sm",onChange:e=>{o(e.target.value)},placeholder:"撰写评论 ...",isInvalid:s.isInvalid}),(0,n.jsx)(E.Z.Control.Feedback,{type:"invalid",children:s.errorMsg})]}),(0,n.jsxs)("div",{className:"my-3 d-flex align-items-center justify-content-end",children:[(0,n.jsx)(T,{onSelected:m}),(0,n.jsx)(d.Z,{variant:"outline-secondary",size:"sm",className:"me-2 edit-top-comment-cancel-btn cancelEdit",onClick:()=>{i?a({...s,isEdit:!1},i):a({...s,isEdit:!1})},children:"取消"}),(0,n.jsx)(d.Z,{size:"sm",onClick:()=>r({item:s,parentItem:i}),disabled:!s.original_text,children:"提交"})]})]})},W=(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(a(),{id:"fbbcc7eb8f14ecf0",children:".edit-form .comment-text{overflow:hidden;word-wrap:break-word;overflow-wrap:break-word;resize:none;min-height:31px}.edit-form.edit-reply-form .comment-text{overflow:hidden;word-wrap:break-word;overflow-wrap:break-word;resize:none;min-height:31px;height:29px}"})}),X=e=>(0,n.jsxs)(n.Fragment,{children:[W,(0,n.jsx)(G,{...e})]});var J=l.memo(X),ee=s(52967);let et=e=>{let{total:t,page:s,getData:i}=e,a=()=>{let e=document.getElementById("comment-area"),t=e.getBoundingClientRect().top+window.pageYOffset+-65;window.scrollTo({top:t})},l=e=>{i(e),a()};return(0,n.jsx)("div",{className:"d-flex justify-content-center mt-4 mb-1",children:(0,n.jsxs)(ee.Z,{size:"sm",className:"mb-0",children:[(0,n.jsx)(ee.Z.Item,{disabled:1===s,onClick:()=>l(s-1),children:"上一页"}),[...Array(Math.ceil(t/15))].map(()=>0).map((e,t)=>(0,n.jsx)(ee.Z.Item,{active:s===t+1,onClick:()=>l(t+1),children:t+1},"page".concat(t))),(0,n.jsx)(ee.Z.Item,{disabled:s===[...Array(Math.ceil(t/15))].map(()=>0).length,onClick:()=>l(s+1),children:"下一页"})]})})};var es=(0,m.$j)(e=>{let{global:t}=e;return{sessionUser:t.sessionUser}})(l.memo(et)),en=s(87021),ei=s(39171);let ea=!0,el={min:2,max:600},er=e=>{let{commentContent:t,isShowComment:s,inputRef:i,setCommentContent:a,onComment:c,sessionUser:o,defaultVisibleTip:m=!1}=e,[u,p]=(0,l.useState)(t.length>280),[x,h]=(0,l.useState)(m),[f,v]=(0,l.useState)({isInvalid:!1,msg:""});(0,l.useEffect)(()=>{m!==x&&h(m)},[m]),(0,l.useEffect)(()=>{p(t.length>280)},[t]),(0,l.useEffect)(()=>{s&&i.current.focus()},[s]);let j=e=>{v(e)},g=e=>{let t=e.keyCode;13===t&&(e.ctrlKey||e.metaKey)&&ea&&(ea=!1,setTimeout(()=>{ea=!0},700),c({item:"comment",callback:j}))},b=e=>{let t=i.current,{value:s,selectionStart:n=0}=t,l=s.slice(0,n)+e+s.slice(n);a(l);let r=n+e.length;t.setSelectionRange(r,r),t.focus()},y=()=>c({item:"comment",callback:j});return(0,n.jsx)(r.Z,{className:"bg-light border-0 mt-2 ".concat(s?"":"hidden"),onKeyDown:g,tabIndex:2,children:(0,n.jsxs)(r.Z.Body,{children:[(0,n.jsxs)("div",{className:"media-body",children:[(0,n.jsxs)(Z.Z,{className:"mb-3",children:[(0,n.jsxs)(B,{element:i.current,children:[(0,n.jsx)(E.Z.Control,{as:"textarea",rows:1,ref:i,value:t,size:"sm",onChange:e=>{a(e.target.value)},className:"comment-text",placeholder:"给问答点赞就是支持，请勿在评论里发布“+1、感谢”等信息",onFocus:e=>{o||(e.preventDefault(),(0,k.bg)(),i.current.blur())},isInvalid:f.isInvalid}),(0,n.jsx)(E.Z.Control.Feedback,{type:"invalid",children:f.msg})]}),(0,n.jsx)(en.Z,{target:i.current,show:s&&u,placement:"top",children:e=>(0,n.jsx)(ei.Z,{className:"qa-tooltip",...e,children:"你正在输入大段内容，如果是回答或补充信息，请直接编辑原文"})})]}),(0,n.jsxs)("div",{className:"d-flex flex-md-row flex-column justify-content-md-between align-items-md-center",children:[(0,n.jsx)("small",{className:"text-secondary",children:"评论用于指出存在的问题，提醒作者澄清改进，请勿在评论里回答或补充信息"}),(0,n.jsxs)("div",{className:"d-flex align-items-center justify-content-end",children:[(0,n.jsx)(d.Z,{variant:"link",className:"me-3 btn-reset",onClick:e=>{e.preventDefault(),h(!x)},"aria-label":"提示",children:(0,n.jsx)("i",{className:"far fa-circle-info text-secondary"})}),(0,n.jsx)(T,{onSelected:b}),(0,n.jsx)(M.Z,{size:"sm",className:"float-end",onClick:y,disabled:!t||t.length<el.min||t.length>el.max,children:"提交评论"})]})]})]}),(0,n.jsxs)(S.Z,{show:x,variant:"info",className:"mt-3 my-0 font-size-14",children:["评论支持部分 Markdown 语法：",(0,n.jsx)("code",{children:"**粗体** _斜体_ [链接](http://example.com) `代码` - 列表 > 引用"}),"。你还可以使用 ",(0,n.jsx)("code",{children:"@ "}),"来通知其他用户。"]})]})})},ec=(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(a(),{id:"2a897c3644246ea1",children:".qa-tooltip .tooltip-inner{max-width:408px!important}"})}),eo=e=>(0,n.jsxs)(n.Fragment,{children:[ec,(0,n.jsx)(er,{...e})]});var ed=(0,m.$j)(e=>{let{global:t}=e;return{sessionUser:t.sessionUser}})(l.memo(eo));let em=!0,eu={min:2,max:600},ep=["question","answer"],ex=e=>{let{item:t,parentItem:s,onChangeOfComment:i,onComment:a,className:r,onEditComment:c,defaultVisibleTip:o=!1,mode:m}=e,p=ep.includes(m)?'给问答点赞就是支持，请勿在评论里发布“+1、感谢”等信息"':"撰写评论 …",[x,h]=(0,l.useState)(!1),[f,v]=(0,l.useState)(o),j=(0,l.useRef)(null),[g,b]=(0,l.useState)({isInvalid:!1,msg:""}),{commentVal:y=""}=t||{};(0,l.useEffect)(()=>{ep.includes(m)&&h(y.length>280)},[y]),(0,l.useEffect)(()=>{o!==f&&v(o)},[o]),(0,l.useEffect)(()=>{if((null==j?void 0:j.current)&&((0,u.Z)(j.current),t.commentVal)){let e=t.commentVal.length;j.current.setSelectionRange(e,e)}},[j]);let N=e=>{b(e)},w=e=>{let n=e.keyCode;13===n&&(e.ctrlKey||e.metaKey)&&em&&(em=!1,setTimeout(()=>{em=!0},700),a({item:t,parentItem:s,callback:N}))},D=e=>{s?i({...t,commentVal:e},s):i({...t,commentVal:e})},k=e=>{let t=j.current;if(!t)return;let{value:s,selectionStart:n=0}=t,i=s.slice(0,n)+e+s.slice(n);D(i);let a=n+e.length;t.setSelectionRange(a,a),t.focus()},_=()=>a({item:t,parentItem:s,callback:N});return(0,n.jsxs)(E.Z,{className:"card-body add-comment-form ".concat(r),onKeyDown:w,children:[(0,n.jsxs)(Z.Z,{className:"mb-3",children:[(0,n.jsxs)("small",{className:"text-secondary",children:["回复"," ",(0,n.jsxs)("a",{href:t.user.url,onClick:e=>{s?c(t,s,e):c(t,"",e)},children:[t.user.name," \xd7"]})]}),(0,n.jsxs)(B,{element:j.current,children:[(0,n.jsx)(E.Z.Control,{as:"textarea",value:t.commentVal,autoFocus:!0,ref:j,size:"sm",rows:1,onChange:e=>{D(e.target.value)},className:"form-control form-control-sm comment-reply mt-2",placeholder:p,isInvalid:g.isInvalid}),(0,n.jsx)(E.Z.Control.Feedback,{type:"invalid",children:g.msg})]}),(0,n.jsx)(en.Z,{target:j.current,show:f&&x,placement:"top",children:e=>(0,n.jsx)(ei.Z,{className:"qa-tooltip",...e,children:"你正在输入大段内容，如果是回答或补充信息，请直接编辑原文"})})]}),(0,n.jsxs)("div",{className:"d-flex flex-md-row flex-column justify-content-md-between align-items-md-center",children:[(0,n.jsx)("small",{className:"text-secondary",children:"评论用于指出存在的问题，提醒作者澄清改进，请勿在评论里回答或补充信息"}),(0,n.jsxs)("div",{className:"d-flex align-items-center justify-content-end",children:[(0,n.jsx)(d.Z,{variant:"link",className:"me-3 btn-reset",onClick:e=>{e.preventDefault(),v(!f)},children:(0,n.jsx)("i",{className:"far fa-circle-info text-secondary"})}),(0,n.jsx)(T,{onSelected:k}),(0,n.jsx)(M.Z,{size:"sm",className:"float-end",onClick:_,disabled:!y||y.length<eu.min||y.length>eu.max,children:"提交评论"})]})]}),(0,n.jsxs)(S.Z,{show:f,variant:"info",className:"mt-3 my-0 font-size-14",children:["评论支持部分 Markdown 语法：",(0,n.jsx)("code",{children:"**粗体** _斜体_ [链接](http://example.com) `代码` - 列表 > 引用"}),"。你还可以使用 ",(0,n.jsx)("code",{children:"@ "}),"来通知其他用户。"]})]})};var eh=l.memo(ex);let ef=e=>{var t,s;let{sessionUser:i,item:a,subItem:r,onEditComment:c,onEdit:o,onRemove:m,onReport:u}=e,[p,x]=(0,l.useState)(r.is_liked),[h,f]=(0,l.useState)(r.votes),v=(e,t)=>{t.preventDefault(),(0,k.bg)()&&(0,w.arA)({id:e.id,is_like:e.is_liked?0:1}).then(()=>{f(p?h-1:h+1),x(!p)})},j=(null===(t=r.member_actions)||void 0===t?void 0:t.filter(e=>"edit"===e.action).length)>0,g=(null===(s=r.member_actions)||void 0===s?void 0:s.filter(e=>"delete"===e.action).length)>0;return(0,n.jsxs)("div",{className:"handle-bar font-size-14 d-flex justify-content-between",children:[(0,n.jsxs)("div",{children:[(0,n.jsxs)(d.Z,{variant:"link",className:"text-secondary btn-reset",onClick:e=>v(r,e),"aria-label":"点赞",children:[(0,n.jsx)("span",{className:"mainLike-comment ".concat(p?"text-primary":""),children:(0,n.jsx)("i",{className:"fa-w-16 ".concat(p?"fas fa-thumbs-up":"far fa-thumbs-up"),style:{width:"1em"}})}),h>0&&(0,n.jsx)("span",{className:"mainLike-commentNum  ms-1",children:h})]}),(0,n.jsx)("span",{className:"split-dot"}),(0,n.jsx)(d.Z,{variant:"link",className:"text-secondary btn-reply btn-reset",onClick:e=>{(0,k.bg)()&&c(r,a,e)},children:"回复"}),(0,n.jsx)("span",{className:"split-dot"}),(0,n.jsx)("span",{className:"text-secondary",children:(0,D.dq)(r.created)})]}),(0,n.jsxs)("div",{className:"comment-control-area d-none",children:[i&&j&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(d.Z,{variant:"link",className:"text-secondary edit btn-reset",onClick:e=>{e.preventDefault(),o(r,a)},children:"编辑"}),(0,n.jsx)("span",{className:"split-dot"})]}),i&&g&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(d.Z,{variant:"link",className:"text-secondary delete btn-reset",onClick:e=>m(r.id,e),children:"删除"}),(0,n.jsx)("span",{className:"split-dot"})]}),i&&(0,n.jsx)(d.Z,{variant:"link",className:"text-secondary reply-report btn-reset",onClick:e=>u(r,e),children:"举报"})]})]})};var ev=(0,m.$j)(e=>{let{global:t}=e;return{sessionUser:t.sessionUser}})(l.memo(ef)),ej=s(50337);let eg=e=>{let{allTotal:t,sort:s,setSort:i,aId:a}=e;return(0,n.jsxs)(r.Z.Header,{className:"d-flex align-items-center justify-content-between bg-transparent border-0",children:[(0,n.jsxs)("strong",{children:[t," 条评论"]}),(0,n.jsxs)(ej.Z,{"aria-label":"Basic",children:[(0,n.jsx)(d.Z,{as:"a",href:"/a/".concat(a,"?sort=votes"),size:"sm",variant:"votes"===s?"secondary":"outline-secondary",onClick:e=>{e.preventDefault(),i("votes")},children:"得票"}),(0,n.jsx)(d.Z,{as:"a",href:"/a/".concat(a,"?sort=newest"),size:"sm",variant:"newest"===s?"secondary":"outline-secondary",onClick:e=>{e.preventDefault(),i("newest")},children:"最新"})]})]})};var eb=l.memo(eg),ey=s(26042);let eN="",ew=["question","answer"],eD=e=>{let{id:t,mode:s="article",isShowComment:i=!1,setCommentState:a,eventObject:p,user:h={},isFetchComments:v=!0,sessionUser:g}=e,{rank:_=0}=(null==g?void 0:g.user)||{},Z=(0,l.useRef)(null),[E,S]=(0,l.useState)(""),I=(0,m.I0)(),{location:{query:R={}}}=(0,m.k6)();Z.current&&(Z.current.value=E);let[F,z]=(0,l.useState)([]),[U,q]=(0,l.useState)({isShow:!1,id:""}),[O,T]=(0,l.useState)({page:1,init:!0}),[M,V]=(0,l.useState)(0),[K,L]=(0,l.useState)(0),[P,A]=(0,l.useState)("newest"===R.sort?"newest":"votes"),[B,H]=(0,l.useState)(!1),[Q,G]=(0,l.useState)(!1),W=(0,l.useRef)({}),[X,ee]=(0,l.useState)(!1);(0,l.useEffect)(()=>{Z.current&&(0,u.Z)(Z.current)},[Z]),(0,l.useEffect)(()=>{T({page:1,init:!0})},[t]),(0,l.useEffect)(()=>{if(!v){z([]);return}1===O.page&&!0===O.init&&en()},[O,v]),(0,l.useEffect)(()=>{if(!X){ee(!0);return}T({page:1,init:!0})},[P]),(0,l.useEffect)(()=>{B&&(F.map(e=>(e.hidden=!1,e)),z(j()(F,["created"])))},[B]),(0,l.useEffect)(()=>{if(!(f()(F)||f()(p))&&!(O.page>1)&&String(t)===String(p.root.object_id)&&s===p.root.type&&String(t)===String(p.root.object_id)&&"comment"===p.current.type){var e,n;let t;let i=x()(F,["id",Number((null==p?void 0:null===(e=p.current)||void 0===e?void 0:e.object_id)||0)]);i<0&&(F.forEach(e=>{t=[...t||[],...e.replies||[]]}),i=x()(t,["id",Number((null==p?void 0:null===(n=p.current)||void 0===n?void 0:n.object_id)||0)])),["question","answer"].includes(s)&&i>2&&(F.splice(i,1),z([p.current.comment,...F])),-1===i&&z([p.current.comment,...F])}},[F,p,O]),(0,l.useEffect)(()=>{I({type:"global/pushPageUser",payload:{pathName:window.location.pathname,users:F.map(e=>null==e?void 0:e.user)}}),"question"===s&&I({type:"action/saveComments",payload:{id:t,comments:"article"===s?K:null==F?void 0:F.length}})},[F]);let et=e=>{let{item:n,parentItem:i,callback:l}=e;return new Promise((e,r)=>{var c,o;if(!(0,k.bg)()){r(!1);return}let d={};if(i?d={reply_comment_id:i.id,reply_user_id:null===(c=n.user)||void 0===c?void 0:c.id}:(null==n?void 0:n.isReply)&&(d={reply_comment_id:n.reply_comment_id||n.id,reply_user_id:null===(o=n.user)||void 0===o?void 0:o.id}),n.id&&!n.isReply&&n.isEdit?(0,w.uAg)({id:n.id,object_id:t,...d,text:null==n?void 0:n.original_text}).then(e=>{i?z(F.map(t=>((null==t?void 0:t.id)===i.id&&(null==t||t.replies.forEach(t=>{t.id===e.id&&(t.isEdit=!1,t.parsed_text=e.parsed_text)})),t))):z(F.map(t=>(t.id===e.id&&(t.parsed_text=null==e?void 0:e.parsed_text,t.isEdit=!1),t))),"function"==typeof a&&a(!1)}).finally(()=>{e(!0)}):(0,w.UI8)({object_id:t,...d,text:(null==n?void 0:n.commentVal)||E}).then(e=>{if("function"==typeof l&&l({isInvalid:!1,msg:""}),"string"==typeof n?S(""):z(F.map(e=>(i?e.id===i.id&&e.replies.forEach(e=>{e.id===n.id&&(e.isReply=!1)}):e.id===n.id&&(e.isReply=!1,e.commentVal=""),e))),"article"===s&&"string"!=typeof n)z(F.map(t=>{if(i){if(t.id===i.id){let s=x()(t.replies,{id:n.id});t.replies.splice(s+1,0,e.comment)}}else t.id===n.id&&(f()(t.replies)?t.replies=[e.comment]:t.replies.unshift(e.comment));return t}));else if("string"!=typeof n){let t=x()(F,{id:n.id});F.splice(t+1,0,e.comment),z([...F])}else z([e.comment,...F]);"function"==typeof a&&a(!1)}).catch(e=>{(null==e?void 0:e.isError)&&"function"==typeof l&&l({isInvalid:!0,msg:e.reply_comment_id||e.text})}).finally(()=>{e(!0)}),"question"===s&&new $.Z("qa_detailsPage_commentQuestion").clickEvent({question_url:"/q/".concat(t)}),"answer"===s){let e=window.location.pathname;e.indexOf("/a-")>-1&&(e=e.split("/a-")[0]),new $.Z("qa_detailsPage_commentAnswer").clickEvent({question_url:e,answer_id:t})}})},en=function(){let{commentId:e="",commentPage:n=1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=n;(0,w.liG)({objectId:t,commentId:e,page:i,sort:"newest"===P?"newest":"votes",is_direct:"article"===s?0:1}).then(t=>{e?O[e]?(O[e].page+=1,T({...O,init:!1}),i=O[e].page):T({...O,[e]:{page:1},init:!1}):T({...O,page:n,init:!1}),f()(null==t?void 0:t.comments)||ei({commentId:e,res:t,page:i})})},ei=e=>{let{commentId:n,res:i,page:a}=e;if(n){let e=F.map(e=>(e.id===n&&(e.replies=j()(1===a?i.comments:[...e.replies,...i.comments],["created"])),e));z(b()(e,"id")||[])}else if(1===a&&(V(i.total),L(i.all_total),I({type:"action/saveComments",payload:{id:t,comments:i.all_total}})),"article"===s)z(b()(i.comments,"id"));else{let e=1===a?i.comments:[...F,...i.comments];z(e=!B&&ew.includes(s)?j()(e,["votes"],["desc"]).map((e,t)=>(e.hidden=t>2,e)):j()(b()(e,"id"),["created"]))}},ea=(e,t,s)=>{s.preventDefault(),z(t?F.map(s=>(s.id===t.id&&(s.replies=s.replies.map(t=>(t.id===e.id&&(t.isReply=!t.isReply,t.isEdit=!1),t))),s)):F.map(t=>(t.id===e.id&&(t.isReply=!t.isReply,t.isEdit=!1),t)))},el=(e,t)=>{z("object"==typeof t?F.map(s=>(s.id===(null==t?void 0:t.id)&&(s.replies=s.replies.map(t=>(t.id===e.id&&(t=e),t))),s)):F.map(t=>(t.id===e.id&&(t=e),t)))},er=(e,t)=>{t.preventDefault();let s=(0,D.Xf)();if("sf_app"===s){let t=(0,ey.Z)();return t.send("report",{id:e.id}),!1}q({id:e.id,isShow:!0})},ec=e=>{q({...U,isShow:e})},eo=(e,t)=>{z(t?F.map(s=>(s.id===t.id&&(s.replies=s.replies.map(t=>(t.id===e.id&&(t.isEdit=!t.isEdit,t.isReply=!1),t))),s)):F.map(t=>(t.id===e.id&&(t.isEdit=!t.isEdit,t.isReply=!1),t)))},em=(e,t)=>{t.preventDefault(),N.ZP.confirm({title:"删除评论",content:"确定要删除该评论吗",onSuccess:async()=>{await (0,w.YFy)(e),en()}})};(0,l.useEffect)(()=>{if(!Q&&!f()(W.current)&&eN&&eu(eN)){let e=W.current[eN];e&&(0,D.SM)(e),G(!0)}});let eu=(0,l.useCallback)(e=>{let s=(0,D.PQ)({eventObj:p,id:e,type:"comment",parentId:t});return s&&(eN=e),s},[p]),ep=M-(B?null==O?void 0:O.page:0)*15,ex=F.filter(e=>!(null==e?void 0:e.hidden));return(0,n.jsxs)(n.Fragment,{children:[("question"===s||"answer"===s)&&(0,n.jsx)(ed,{defaultVisibleTip:_<50,commentContent:E,isShowComment:i,inputRef:Z,setCommentContent:S,onComment:et}),(0,n.jsxs)(r.Z,{id:"comment-area",className:"comment-wrap ".concat("article"===s?"":0===F.length?"hidden":"bg-light border-0 mt-2"),children:["article"===s&&(0,n.jsx)(eb,{allTotal:K,sort:P,setSort:A,aId:t}),(0,n.jsxs)(r.Z.Body,{className:"article"===s?"":"p-3",children:["article"===s&&(0,n.jsx)(Y,{defaultVisibleTip:_<50,commentContent:E,inputRef:Z,setCommentContent:S,onComment:et}),(0,n.jsx)("div",{className:"comment-body-wrap ".concat(F.filter(e=>!e.hidden).length<1&&"d-none"),children:ex.map((e,i)=>{var a,l,m,u,p,x,v,j,g;let b=e.parsed_text,N=e.reply_user;return f()(N)||b.includes('<a href="'.concat(N.url,'">@').concat(N.name,"</a>"))||(b=b.replace(/^<p>/,'<p><a href="'.concat(N.url,'">@').concat(N.name,"</a> "))),(0,n.jsxs)("div",{ref:t=>W.current[e.id]=t,className:"mb-r media d-flex align-items-start ".concat(ex.length!==i+1&&("article"===s?"mb-4":"mb-3")),children:["article"===s&&(0,n.jsx)(y.Z,{className:"me-3",width:38,height:38,src:null===(a=e.user)||void 0===a?void 0:a.avatar_url,headdress:null===(l=e.user)||void 0===l?void 0:l.headdress_worn}),(0,n.jsxs)("div",{className:"w-0 media-body ".concat(eu(e.id)?"scroll-warning":""),children:[(0,n.jsxs)("div",{className:"commentUnit ".concat("question"===s||"answer"===s?"font-size-14":""),children:[(0,n.jsxs)("div",{className:"mb-1",children:[(0,n.jsxs)("a",{className:"d-uname",href:null===(m=e.user)||void 0===m?void 0:m.url,target:"_blank",children:[(0,n.jsx)("strong",{children:null===(u=e.user)||void 0===u?void 0:u.name}),"article"===s&&(null===(p=e.user)||void 0===p?void 0:p.id)===(null==h?void 0:h.id)&&(0,n.jsx)("span",{className:"text-secondary",children:"（作者）"})]}),"：",!e.isEdit&&(0,n.jsx)("div",{className:"parsedText fmt",dangerouslySetInnerHTML:{__html:b}})]}),e.isEdit&&(0,n.jsx)(J,{onChangeOfComment:el,item:e,onComment:et}),(0,n.jsx)(C,{item:e,onEditComment:ea,onEdit:eo,onRemove:em,onReport:er}),e.isReply&&(0,n.jsx)(r.Z,{className:"bg-light border-0 mt-2",children:(0,n.jsx)(eh,{defaultVisibleTip:_<50,id:t,className:"".concat("question"===s||"answer"===s?"p-0":"p-3"),mode:s,onChangeOfComment:el,item:e,onComment:et,onEditComment:ea})})]}),(0,n.jsx)("div",{className:"replies ".concat(f()(e.replies)?"hidden":""),children:(0,n.jsx)(r.Z,{className:"bg-light border-0 mt-2",children:(0,n.jsxs)(r.Z.Body,{className:"p-3",children:[(0,n.jsx)(c.Z,{className:"reply-list",children:null===(x=e.replies)||void 0===x?void 0:x.map((i,a)=>{var l,c,d;let m=i.parsed_text,u=i.reply_user;return f()(u)||m.includes('<a href="'.concat(u.url,'">@').concat(u.name,"</a>"))||(m=m.replace(/^<p>/,'<p><a href="'.concat(u.url,'">@').concat(u.name,"</a> "))),(0,n.jsxs)(o.Z,{ref:e=>W.current[i.id]=e,className:"p-0 border-0 commentUnit ".concat(e.replies.length!==a+1&&"mb-3"," ").concat(eu(i.id)?"scroll-warning":""," "),children:[(0,n.jsxs)("div",{className:"font-size-14 mb-1",children:[(0,n.jsxs)("a",{className:"d-uname",href:null===(l=i.user)||void 0===l?void 0:l.url,target:"_blank",children:[(0,n.jsx)("strong",{children:null===(c=i.user)||void 0===c?void 0:c.name}),"article"===s&&(null===(d=i.user)||void 0===d?void 0:d.id)===(null==h?void 0:h.id)&&(0,n.jsx)("span",{className:"text-secondary",children:"（作者）"})]}),"：",!i.isEdit&&(0,n.jsx)("div",{className:"parsedText fmt",dangerouslySetInnerHTML:{__html:m}})]}),i.isEdit&&(0,n.jsx)(J,{isChild:!0,onChangeOfComment:el,item:i,parentItem:e,onComment:et}),(0,n.jsx)(ev,{item:e,subItem:i,onEditComment:ea,onEdit:eo,onRemove:em,onReport:er}),i.isReply&&(0,n.jsx)(r.Z,{className:"bg-light border-0 mt-2",children:(0,n.jsx)(eh,{defaultVisibleTip:_<50,id:t,onChangeOfComment:el,item:i,onComment:et,parentItem:e,className:"p-0",onEditComment:ea})})]},i.id)})}),e.replies&&e.replies_total>e.replies.length&&e.replies_total-15*((null===(v=O[e.id])||void 0===v?void 0:v.page)||0)>0&&(0,n.jsx)("div",{className:"font-size-14 d-flex mt-3",children:(0,n.jsx)(d.Z,{variant:"link",className:"text-secondary next-page-btn btn-reset",onClick:t=>{t.preventDefault(),en({commentId:e.id})},children:e.replies_total<15?"共 ".concat(e.replies_total," 条回复"):"更多 ".concat(15>e.replies_total-15*((null===(j=O[e.id])||void 0===j?void 0:j.page)||0)?e.replies_total-15*((null===(g=O[e.id])||void 0===g?void 0:g.page)||0):15," 条回复")})})]})})})]})]},e.id)})}),"article"===s?M>15&&(0,n.jsx)(es,{total:M,page:O.page,getData:e=>en({commentPage:e})}):M>3&&ep>0&&(0,n.jsx)("div",{className:"font-size-14 d-flex mt-3",children:(0,n.jsx)(d.Z,{variant:"link",className:"text-secondary next-page-btn btn-reset",onClick:e=>{e.preventDefault(),B?en({commentPage:O.page+1}):H(!0)},children:M<15?"共 ".concat(M," 条评论"):"更多 ".concat(15>ep?ep:15," 条评论")})})]})]}),(0,n.jsx)(N.yW,{...U,setModalStatus:ec})]})},ek=(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(a(),{id:"78891ba36deccadf",children:'.comment-wrap .media-body .fmt,.comment-wrap .media-body .fmt>p:first-child{display:inline}.comment-wrap .media-body .fmt>p:first-child::after{display:block;content:"";margin-bottom:1.25rem}.comment-wrap .media-body .fmt>p:last-child::after{display:none!important}.comment-wrap .commentUnit:hover .control-area,.comment-wrap .commentUnit:hover .comment-control-area{display:-webkit-box!important;display:-webkit-flex!important;display:-moz-box!important;display:-ms-flexbox!important;display:flex!important}.comment-wrap .comment-reply{overflow:hidden;word-wrap:break-word;overflow-wrap:break-word;resize:none}.comment-wrap .dropdown-item.active,.comment-wrap .dropdown-item:active{background:#f8f9fa!important;color:inherit!important}.comment-wrap .reply-list .list-group-item{background-color:unset}'})}),e_=e=>(0,n.jsxs)(n.Fragment,{children:[ek,(0,n.jsx)(eD,{...e})]});var eC=(0,m.$j)(e=>{let{global:t}=e;return{sessionUser:t.sessionUser}})(l.memo(e_))}}]);